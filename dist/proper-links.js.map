{"version":3,"file":"proper-links.js","sources":["../src/proper-links.ts"],"sourcesContent":["/* eslint-disable @typescript-eslint/no-explicit-any */\nimport { assert } from '@ember/debug';\nimport { registerDestructor } from '@ember/destroyable';\nimport { getOwner } from '@ember/owner';\n\nimport type EmberRouter from '@ember/routing/router';\nimport type RouterService from '@ember/routing/router-service';\n\ntype Constructor<T extends {} = {}> = { new (...args: any[]): T };\n\nexport interface Options {\n  ignore?: string[];\n}\n\nexport function properLinks(\n  options: Options\n): <Instance extends {}, Klass = { new (...args: any[]): Instance }>(klass: Klass) => Klass;\n\nexport function properLinks<Instance extends {}, Klass = { new (...args: any[]): Instance }>(\n  klass: Klass\n): Klass;\n/**\n * @internal\n */\nexport function properLinks<Instance extends {}, Klass = { new (...args: any[]): Instance }>(\n  options: Options,\n  klass: Klass\n): Klass;\n\nexport function properLinks<Instance extends {}, Klass = { new (...args: any[]): Instance }>(\n  ...args: [Options] | [Klass] | [Options, Klass]\n): Klass | ((klass: Klass) => Klass) {\n  let options: Options = {};\n\n  let klass: undefined | Klass = undefined;\n\n  if (args.length === 2) {\n    options = args[0] as Options;\n    klass = args[1] as Klass;\n  } else if (args.length === 1) {\n    if (typeof args[0] === 'object') {\n      // TODO: how to get first arg type correct?\n      return (klass: Klass) => properLinks(args[0] as any, klass);\n    } else {\n      klass = args[0];\n    }\n  }\n\n  let ignore = options.ignore || [];\n\n  assert(`klass was not defined. possibile incorrect arity given to properLinks`, klass);\n\n  return class RouterWithProperLinks extends (klass as unknown as Constructor<EmberRouter>) {\n    // SAFETY: we literally do not care about the args' type here,\n    //         because we just call super\n    constructor(...args: any[]) {\n      super(...args);\n\n      setup(this, ignore);\n    }\n  } as unknown as Klass;\n}\n\n/**\n * Setup proper links without a decorator.\n * This function only requires that a framework object with an owner is passed.\n */\nexport function setup(parent: object, ignore?: string[]) {\n  const handler = (event: MouseEvent) => {\n    /**\n     * event.target may not be an anchor,\n     * it may be a span, svg, img, or any number of elements nested in <a>...</a>\n     */\n    let interactive = isLink(event);\n\n    if (!interactive) return;\n\n    let owner = getOwner(parent);\n\n    assert('owner is not present', owner);\n\n    let routerService = owner.lookup('service:router');\n\n    handle(routerService, interactive, ignore ?? [], event);\n  };\n\n  document.body.addEventListener('click', handler, false);\n\n  registerDestructor(parent, () => document.body.removeEventListener('click', handler));\n}\n\nexport function isLink(event: Event) {\n  /**\n   * Using composed path in case the link is removed from the DOM\n   * before the event handler evaluates\n   */\n  let composedPath = event.composedPath();\n\n  for (let element of composedPath) {\n    if (element instanceof HTMLAnchorElement) {\n      return element;\n    }\n  }\n}\n\nexport function handle(\n  router: RouterService,\n  element: HTMLAnchorElement,\n  ignore: string[],\n  event: MouseEvent\n) {\n  if (!element) return;\n  /**\n   * If we don't have an href, the <a> is invalid.\n   * If you're debugging your code and end up finding yourself\n   * early-returning here, please add an href ;)\n   */\n  if (!element.href) return;\n\n  /**\n   * This is partially an escape hatch, but any time target is set,\n   * we are usually wanting to escape the behavior of single-page-apps.\n   *\n   * Some folks desire to have in-SPA links, but still do native browser behavior\n   * (which for the case of SPAs is a full page refresh)\n   * but they can set target=\"_self\" to get that behavior back if they want.\n   *\n   * I expect that this'll be a super edge case, because the whole goal of\n   * \"proper links\" is to do what is expected, always -- for in-app SPA links\n   * as well as external, cross-domain links\n   */\n  if (element.target) return;\n\n  /**\n   * If the click is not a \"left click\" we don't want to intercept the event.\n   * This allows folks to\n   * - middle click (usually open the link in a new tab)\n   * - right click (usually opens the context menu)\n   */\n  if (event.button !== 0) return;\n\n  /**\n   * for MacOS users, this default behavior opens the link in a new tab\n   */\n  if (event.metaKey) return;\n\n  /**\n   * for for everyone else, this default behavior opens the link in a new tab\n   */\n  if (event.ctrlKey) return;\n\n  /**\n   * The default behavior here downloads the link content\n   */\n  if (event.altKey) return;\n\n  /**\n   * The default behavior here opens the link in a new window\n   */\n  if (event.shiftKey) return;\n\n  /**\n   * If another event listener called event.preventDefault(), we don't want to proceed.\n   */\n  if (event.defaultPrevented) return;\n\n  /**\n   * The href includes the protocol/host/etc\n   * In order to not have the page look like a full page refresh,\n   * we need to chop that \"origin\" off, and just use the path\n   */\n  let url = new URL(element.href);\n\n  /**\n   * If the domains are different, we want to fall back to normal link behavior\n   *\n   */\n  if (location.origin !== url.origin) return;\n\n  /**\n   * We can optionally declare some paths as ignored,\n   * or \"let the browser do its default thing,\n   * because there is other server-based routing to worry about\"\n   */\n  if (ignore.includes(url.pathname)) return;\n\n  let fullHref = `${url.pathname}${url.search}${url.hash}`;\n\n  let rootURL = router.rootURL;\n\n  let withoutRootURL = fullHref.slice(rootURL.length);\n\n  // re-add the \"root\" sigil\n  // we removed it when we chopped off the rootURL,\n  // because the rootURL often has this attached to it as well\n  if (!withoutRootURL.startsWith('/')) {\n    withoutRootURL = `/${withoutRootURL}`;\n  }\n\n  try {\n    let routeInfo = router.recognize(fullHref);\n\n    if (routeInfo) {\n      event.preventDefault();\n      event.stopImmediatePropagation();\n      event.stopPropagation();\n\n      router.transitionTo(withoutRootURL);\n\n      return false;\n    }\n  } catch (e) {\n    if (e instanceof Error && e.name === 'UnrecognizedURLError') {\n      return;\n    }\n\n    throw e;\n  }\n}\n"],"names":["properLinks","args","options","klass","undefined","length","ignore","assert","RouterWithProperLinks","constructor","setup","parent","handler","event","interactive","isLink","owner","getOwner","routerService","lookup","handle","document","body","addEventListener","registerDestructor","removeEventListener","composedPath","element","HTMLAnchorElement","router","href","target","button","metaKey","ctrlKey","altKey","shiftKey","defaultPrevented","url","URL","location","origin","includes","pathname","fullHref","search","hash","rootURL","withoutRootURL","slice","startsWith","routeInfo","recognize","preventDefault","stopImmediatePropagation","stopPropagation","transitionTo","e","Error","name"],"mappings":"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"}